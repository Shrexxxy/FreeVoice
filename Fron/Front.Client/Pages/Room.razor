@page "/room1"
@using System.Net.WebSockets
@using System.Text.Json
@using Shared.Model
@inject IJSRuntime JS
@inject NavigationManager Navigation
@implements IAsyncDisposable

<PageTitle>Голосовая комната 1</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
    <MudPaper Class="pa-4" Elevation="5">
        <!-- Шапка комнаты -->
        <MudGrid>
            <MudItem xs="12" Class="d-flex align-center justify-space-between mb-4">
                <MudText Typo="Typo.h4">🎤 Голосовая комната 1</MudText>
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Error" 
                          OnClick="LeaveRoom"
                          EndIcon="@Icons.Material.Filled.ExitToApp">
                    Покинуть комнату
                </MudButton>
            </MudItem>
        </MudGrid>
        
        <!-- Основной контент -->
        <MudGrid>
            <!-- Блок чата -->
            <MudItem xs="12" md="8">
                <MudPaper Class="pa-4" Height="600px" Style="overflow-y: auto;">
                    <div @ref="_chatContainer">
                        @if (!_isConnected)
                        {
                            <MudText Align="Align.Center" Class="my-4">
                                Подключение к чату...
                            </MudText>
                        }
                        else
                        {
                            @foreach (var message in _messages)
                            {
                                <div class="mb-3">
                                    @if (message.IsSystemMessage)
                                    {
                                        <MudText Class="text-center text-grey" Typo="Typo.body2">
                                            @message.Timestamp.ToString("HH:mm") - @message.Message
                                        </MudText>
                                    }
                                    else
                                    {
                                        <MudCard Class="pa-3" Elevation="1">
                                            <div class="d-flex justify-space-between align-start">
                                                <div>
                                                    <MudText Typo="Typo.subtitle2" 
                                                            Color="Color.Primary">
                                                        @message.UserName
                                                    </MudText>
                                                    <MudText Typo="Typo.body2">
                                                        @message.Message
                                                    </MudText>
                                                </div>
                                                <MudText Typo="Typo.caption" Color="Color.Tertiary">
                                                    @message.Timestamp.ToString("HH:mm")
                                                </MudText>
                                            </div>
                                        </MudCard>
                                    }
                                </div>
                            }
                        }
                    </div>
                </MudPaper>
                
                <!-- Поле ввода сообщения -->
                <MudPaper Class="pa-3 mt-3" Elevation="2">
                    <MudGrid>
                        <MudItem xs="10">
                            <MudTextField @bind-Value="_newMessage"
                                         Variant="Variant.Outlined"
                                         Placeholder="Введите сообщение..."
                                         FullWidth="true"
                                         OnKeyDown="@(async (e) => { if (e.Key == "Enter") await SendMessage(); })"
                                         Disabled="@(!_isConnected)" />
                        </MudItem>
                        <MudItem xs="2" Class="d-flex align-center">
                            <MudButton Variant="Variant.Filled" 
                                     Color="Color.Primary" 
                                     OnClick="SendMessage"
                                     FullWidth="true"
                                     Disabled="@(!_isConnected || string.IsNullOrWhiteSpace(_newMessage))">
                                <MudIcon Icon="@Icons.Material.Filled.Send" />
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>
            
            <!-- Панель участников -->
            <MudItem xs="12" md="4">
                <MudPaper Class="pa-4" Height="600px">
                    <MudText Typo="Typo.h6" Class="mb-3">👥 Участники</MudText>
                    <MudList>
                        @foreach (var user in _users)
                        {
                            <MudListItem Text="@user" 
                                        Icon="@Icons.Material.Filled.Person" />
                        }
                    </MudList>
                    
                    <!-- Элементы управления голосом -->
                    <div class="mt-6">
                        <MudText Typo="Typo.h6" Class="mb-3">🎤 Управление голосом</MudText>
                        
                        <MudGrid>
                            <MudItem xs="6">
                                <MudButton Variant="Variant.Filled" 
                                         Color="@(_isMuted ? Color.Error : Color.Success)"
                                         OnClick="ToggleMicrophone"
                                         FullWidth="true"
                                         Class="mb-2">
                                    @if (_isMuted)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.MicOff" />
                                        <MudText>Вкл микрофон</MudText>
                                    }
                                    else
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Mic" />
                                        <MudText>Выкл микрофон</MudText>
                                    }
                                </MudButton>
                            </MudItem>
                            <MudItem xs="6">
                                <MudButton Variant="Variant.Filled" 
                                         Color="@(_isDeafened ? Color.Error : Color.Success)"
                                         OnClick="ToggleDeafen"
                                         FullWidth="true"
                                         Class="mb-2">
                                    @if (_isDeafened)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.HeadsetOff" />
                                        <MudText>Вкл звук</MudText>
                                    }
                                    else
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Headset" />
                                        <MudText>Выкл звук</MudText>
                                    }
                                </MudButton>
                            </MudItem>
                        </MudGrid>
                        
                        <!-- Громкость -->
                        <div class="mt-4">
                            <MudText Typo="Typo.body2">Громкость</MudText>
                            <MudSlider T="int" @bind-Value="_volume" Min="0" Max="100" />
                        </div>
                    </div>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudPaper>
</MudContainer>

@code {
    private List<ChatMessage> _messages = new();
    private List<string> _users = new() { "Вы", "User2", "User3" }; // Заглушка
    private string _newMessage = string.Empty;
    private string _userName = "User1"; // В реальном приложении получать из аутентификации
    private bool _isConnected = false;
    private bool _isMuted = false;
    private bool _isDeafened = false;
    private int _volume = 70;
    private ElementReference _chatContainer;
    private WebSocket? _webSocket;
    private CancellationTokenSource _cancellationTokenSource = new();
    
    protected override async Task OnInitializedAsync()
    {
        await ConnectWebSocket();
        await base.OnInitializedAsync();
    }
    
    private async Task ConnectWebSocket()
    {
        try
        {
            var wsProtocol = Navigation.BaseUri.StartsWith("https") ? "wss" : "ws";
            var wsUrl = $"{wsProtocol}://{Navigation.Host}/ws/room1/{_userName}";
            
            _webSocket = new WebSocket();
            await _webSocket.ConnectAsync(new Uri(wsUrl), _cancellationTokenSource.Token);
            
            _isConnected = true;
            _ = ReceiveMessages();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"WebSocket connection failed: {ex.Message}");
        }
    }
    
    private async Task ReceiveMessages()
    {
        var buffer = new byte[1024 * 4];
        
        while (_isConnected && _webSocket?.State == WebSocketState.Open)
        {
            try
            {
                var result = await _webSocket.ReceiveAsync(
                    new ArraySegment<byte>(buffer), 
                    _cancellationTokenSource.Token);
                
                if (result.MessageType == WebSocketMessageType.Text)
                {
                    var messageJson = System.Text.Encoding.UTF8.GetString(buffer, 0, result.Count);
                    var messages = JsonSerializer.Deserialize<List<ChatMessage>>(messageJson) 
                                  ?? new List<ChatMessage>();
                    
                    // Если пришло несколько сообщений (история)
                    if (messages.Count > 1)
                    {
                        _messages = messages;
                    }
                    else if (messages.Count == 1)
                    {
                        // Одно новое сообщение
                        _messages.Add(messages[0]);
                    }
                    
                    await InvokeAsync(StateHasChanged);
                    await ScrollToBottom();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Receive error: {ex.Message}");
                break;
            }
        }
    }
    
    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_newMessage) || !_isConnected)
            return;
        
        var chatMessage = new ChatMessage
        {
            UserName = _userName,
            Message = _newMessage.Trim(),
            Timestamp = DateTime.Now
        };
        
        var messageJson = JsonSerializer.Serialize(chatMessage);
        var buffer = System.Text.Encoding.UTF8.GetBytes(messageJson);
        
        await _webSocket!.SendAsync(
            new ArraySegment<byte>(buffer),
            WebSocketMessageType.Text,
            true,
            _cancellationTokenSource.Token);
        
        _newMessage = string.Empty;
    }
    
    private async Task ScrollToBottom()
    {
        await JS.InvokeVoidAsync("scrollToBottom", _chatContainer);
    }
    
    private void ToggleMicrophone()
    {
        _isMuted = !_isMuted;
        // Здесь будет логика управления микрофоном через WebRTC
    }
    
    private void ToggleDeafen()
    {
        _isDeafened = !_isDeafened;
        // Здесь будет логика управления звуком
    }
    
    private void LeaveRoom()
    {
        Navigation.NavigateTo("/");
    }
    
    public async ValueTask DisposeAsync()
    {
        _isConnected = false;
        _cancellationTokenSource.Cancel();
        
        if (_webSocket != null)
        {
            await _webSocket.CloseAsync(
                WebSocketCloseStatus.NormalClosure,
                "Closing",
                CancellationToken.None);
            _webSocket.Dispose();
        }
        
        _cancellationTokenSource.Dispose();
    }
}